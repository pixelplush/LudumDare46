<html>
	<head>
		<title>Ludum Dare 46</title>
		<link href="https://fonts.googleapis.com/css?family=Press+Start+2P" rel="stylesheet">
		<!-- <script>class Modal{get Node(){return this._obj}get Classes(){return this._classes}get OnAccepts(){return this._onaccepts}get Dialog(){return this._obj.getElementsByClassName(this._classes.dialog)[0]}constructor(t,e={close:"modal-close",accept:"modal-accept",container:"modal-container",dialog:"modal-dialog"}){this._obj=t,this._classes=e,this._onaccepts=[],this.init()}init(){let t=this;this._obj.addEventListener("click",e=>{e.classList.contains(t._classes.container)&&t.close()});let e=this._obj.getElementsByClassName(this._classes.close);for(let s=0;s<e.length;s++){e[s].addEventListener("click",()=>{t.close()})}let s=this._obj.getElementsByClassName(this._classes.close);for(let e=0;e<s.length;e++){const c=s[e];c.addEventListener("click",()=>{t.accept(c)})}}open(){this._obj.setAttribute("hidden","")}close(){this._obj.removeAttribute("hidden")}accept(t){for(let e=0;e<this._onaccepts.length;e++)this._onaccepts[e](this,t)}addActivator(t){let e=this;t.addEventListener("click",()=>{e.open()})}addActivators(t){let e=this;for(let s=0;s<t.length;s++){t[s].addEventListener("click",()=>{e.open()})}}addClose(t){let e=this;t.addEventListener("click",()=>{e.close()})}addAcceptor(t){let e=this;t.addEventListener("click",()=>{e.accept(t)})}onAccept(t){this._onaccepts.push(t)}}</script> -->
		<link href="https://cdn.jsdelivr.net/gh/nostalgic-css/NES.css@2.3.0/docs/lib/dialog-polyfill.css" rel="stylesheet" crossorigin="anonymous"/>
<script src="https://cdn.jsdelivr.net/gh/nostalgic-css/NES.css@2.3.0/docs/lib/dialog-polyfill.js" crossorigin="anonymous"></script>
		<!-- latest -->
		<link href="https://unpkg.com/nes.css@2.3.0/css/nes-core.min.css" rel="stylesheet">
<link href="https://unpkg.com/nes.icons@2.0.1/css/nes-icons.min.css" rel="stylesheet">
		<link href="web/style.css" rel="stylesheet">
		<script src="https://cdn.jsdelivr.net/npm/comfycipher@latest/web/comfycipher.min.js"></script>
	</head>
	<body>
		<div class="modal-container" hidden="true">
			<div class="modal">
				<dialog class="nes-dialog is-dark" id="dialog-dark">
					<form method="dialog">
						<p class="nes-text is-primary">Secret Decoder</p>
						<div class="nes-table-responsive">
	  						<table class="nes-table is-dark is-bordered is-centered">
								<!-- <thead>
									<tr>
										<th></th>
										<th></th>
										<th></th>
									</tr>
								</thead> -->
								<tbody>
									<tr>
										<td width="25%">
											<center>
												<button type="button" class="nes-btn is-primary" onclick="decode(0)">A</button>
												<button type="button" class="nes-btn is-primary" onclick="decode(1)">B</button>
												<button type="button" class="nes-btn is-primary" onclick="decode(2)">C</button>
												<button type="button" class="nes-btn is-primary" onclick="decode(3)">D</button>
												<button type="button" class="nes-btn is-primary" onclick="decode(4)">E</button>
												<button type="button" class="nes-btn is-primary" onclick="decode(5)">F</button>
												<button type="button" class="nes-btn is-primary" onclick="decode(6)">G</button>
												<button type="button" class="nes-btn is-primary" onclick="decode(7)">H</button>
												<button type="button" class="nes-btn is-primary" onclick="decode(8)">I</button>
												<button type="button" class="nes-btn is-primary" onclick="decode(9)">J</button>
												<button type="button" class="nes-btn is-primary" onclick="decode(10)">K</button>
												<button type="button" class="nes-btn is-primary" onclick="decode(11)">L</button>
											</center>
										</td>
										<td>
											<textarea id="decode-text" rows="15" class="nes-textarea is-dark"></textarea>
										</td>
									</tr>
							    </tbody>
							</table>
						</div>
						<progress id="decode-progress" class="nes-progress short-height is-primary" value="0" max="100"></progress>
						<menu class="dialog-menu">
							<button id="decode-cancel" type="button" class="nes-btn">Cancel</button>
							<button id="decode-reset" type="button" class="nes-btn is-error">Reset</button>
							<button id="decode-save" type="button" class="nes-btn is-warning">Save</button>
						</menu>
					</form>
				</dialog>
			</div>
		</div>
		<div class="container">
			<header class="sticky">
				<div class="container">
					<div class="nav-brand">
					</div>
				</div>
			</header>
			<main class="main-content">
				<section class="nes-container is-dark with-title is-rounded">
					<p class="title">
						<button id="tab-main" type="button" class="nes-btn is-primary">Main</button>
						<button id="tab-memos" type="button" class="nes-btn is-success"><i class="nes-icon search"></i> Memos</button>
						<button id="tab-suspects" type="button" class="nes-btn is-warning"><i class="nes-icon eye"></i> Suspects</button>
						<button id="tab-weapons" type="button" class="nes-btn is-error"><i class="nes-icon bomb"></i> Weapons</button>
					</p>
					<div id="content-main"></div>
					<div id="content-memos">
						<div id="clues" class="word-wrap">
						</div>
					</div>
					<div id="content-decode">
					</div>
					<div id="content-suspects"></div>
					<div id="content-weapons"></div>
				</section>
			</main>
		</div>
		<script>
			document.querySelector( "#tab-main" ).addEventListener( "click", function( ev ) {
				Array.from( document.querySelectorAll( '[id^="content-"]' ) ).forEach( x => x.setAttribute( "hidden", true ) );
				document.querySelector( "#content-main" ).removeAttribute( "hidden" );
			});
			document.querySelector( "#tab-memos" ).addEventListener( "click", function( ev ) {
				Array.from( document.querySelectorAll( '[id^="content-"]' ) ).forEach( x => x.setAttribute( "hidden", true ) );
				document.querySelector( "#content-memos" ).removeAttribute( "hidden" );
			});
			document.querySelector( "#tab-suspects" ).addEventListener( "click", function( ev ) {
				Array.from( document.querySelectorAll( '[id^="content-"]' ) ).forEach( x => x.setAttribute( "hidden", true ) );
				document.querySelector( "#content-suspects" ).removeAttribute( "hidden" );
			});
			document.querySelector( "#tab-weapons" ).addEventListener( "click", function( ev ) {
				Array.from( document.querySelectorAll( '[id^="content-"]' ) ).forEach( x => x.setAttribute( "hidden", true ) );
				document.querySelector( "#content-weapons" ).removeAttribute( "hidden" );
			});
			Array.from( document.querySelectorAll( '[id^="content-"]' ) ).forEach( x => x.setAttribute( "hidden", true ) );
			document.querySelector( "#content-main" ).removeAttribute( "hidden" );

			// let ourModal = new Modal(document.getElementsByClassName("modal")[0]);
			// ourModal.addActivator(document.getElementsByClassName("modal-activator")[0]);
			// ourModal.onAccept((self, node) => {
			//   document.getElementsByClassName("modal-activator")[0].innerHTML = "Modal Accepted";
			//   self.close();
			// });

			document.querySelector( ".modal" ).addEventListener( "click", function( ev ) {
				ev.stopPropagation();
			});

			document.querySelector( ".modal-container" ).addEventListener( "click", function( ev ) {
				document.querySelector( ".modal-container" ).setAttribute( "hidden", "true" );
			});

			document.querySelector( "#decode-cancel" ).addEventListener( "click", function( ev ) {
				document.querySelector( ".modal-container" ).setAttribute( "hidden", "true" );
			});

			document.querySelector( "#decode-reset" ).addEventListener( "click", function( ev ) {
				clearInterval( decodeTimer );
				decodeProgress = 0;
				document.querySelector( "#decode-progress" ).value = decodeProgress;
				document.querySelector( "#decode-text" ).value = originalText;
			});

			document.querySelector( "#decode-save" ).addEventListener( "click", function( ev ) {
				document.querySelector( `#clue-${clueIndex}` ).innerText = document.querySelector( "#decode-text" ).value;
				document.querySelector( ".modal-container" ).setAttribute( "hidden", "true" );
			});

			const suspectClueSentences = [
				"I didn't know this SPECIES could be described as CHARACTERISTIC",
				"People were calling this SPECIES the NICKNAME",
				"I heard they're AGE years old!",
				"The SPECIES was GENDER",
			];
			const peculiarSuspects = [
				{
					name: "Captain of Catastrophe",
					characteristics: [ "Pointy Ears", "Purrrfect Whiskers" ],
					nicknames: [ "Catastrophe", "C-A-T", "Captain" ],
					gender: "male",
					species: "cat",
					sound: [ "meow", "a-mews-ed" ],
					age: "?"
				},
				{
					name: "Sergeant Mayo",
					characteristics: [ "Uniform", "Angry", "Cop", "Sarcastic" ],
					nicknames: [ "Sergeant", "sarge" ],
					gender: "male",
					species: "condiment",
					sound: [ "angry", "yelling" ],
					age: 54
				},
				{
					name: "Dr. D Dawson",
					characteristics: [ "Meticulous", "Proper", "Clean", "Calculating", "Smart" ],
					nicknames: [ "Doctor", "doc", "daws", "Deedeedee" ],
					gender: "female",
					species: "human",
					sound: [ "calm", "alluring" ],
					age: 26
				},
				{
					name: "Jay Son",
					characteristics: [ "Organized", "Clean-Shaven", "Hacker", "Computer-Geek", "Techie" ],
					nicknames: [ "json", "jayjay" ],
					gender: "male",
					species: "artificial intelligence",
					sound: [ "mumbling" ],
					age: 2
				},
				{
					name: "Melia Azedarach",
					characteristics: [ "Smells Good", "Femme Fatale", "Stoic", "Doesn't Speak" ],
					nicknames: [ "Killer Flower", "poison", "danger" ],
					gender: "female",
					species: "tree",
					sound: [ "quiet" ],
					age: 267
				}
			];

			let clues = generateSuspectClues( getRandomElement( peculiarSuspects ) );
			console.log( clues );
			const ciphers = [
				ComfyCipher.Encode.Reverse,
				ComfyCipher.Encode.Base64,
				ComfyCipher.Encode.Rot13,
				ComfyCipher.Encode.Morse,
			];
			console.log( clues.map( c => getRandomElement( ciphers )( c ) ) );
			clues.forEach( ( c, index ) => {
				let clue = getRandomElement( ciphers )( c );
				let contain = document.createElement( "div" );
				contain.setAttribute( "id", `clue-${index}` );
				contain.setAttribute( "class", "nes-container is-rounded is-dark" );
				let elem = document.createElement( "p" );
				elem.innerText = clue;
				contain.append( elem );
				document.querySelector( "#clues" ).append( contain );
				contain.addEventListener( "click", function( ev ) {
					document.querySelector( "#decode-text" ).value = clue;
					clueIndex = index;
					originalText = clue;
					document.querySelector( ".modal-container" ).removeAttribute( "hidden" );
				});
			});

			const deciphers = [
				ComfyCipher.Decode.Reverse,
				ComfyCipher.Decode.Base64,
				ComfyCipher.Decode.Rot13,
				ComfyCipher.Decode.Morse,
			];
			var clueIndex = -1;
			var originalText = "";
			var decodeTimer = null;
			var decodeProgress = 0;
			var decodedMessage = "";
			// Text Decipher Effect by Sadmoody (https://twitch.tv/sadmoody)
			String.prototype.replaceAt=function(index, replacement) {
			    return this.substr(0, index) + replacement+ this.substr(index + replacement.length);
			}

			function scrambleCharacters( messageOld, messageNew, progress ) {
				if( messageOld.length > messageNew.length ) {
					let lengthDiff = messageOld.length - messageNew.length;
					let numCharToRemove = Math.floor( lengthDiff * progress );
					messageOld = messageOld.substr( 0, messageOld.length - numCharToRemove );
				}
				if( messageOld.length < messageNew.length ) {
					messageOld += " ".repeat( messageNew.length - messageOld.length );
				}
				let numCharToReplace = Math.floor( messageNew.length * progress );
				for( let i = 0; i < numCharToReplace; i++ ) {
					var index = Math.floor( Math.random()*messageNew.length );
					messageOld = messageOld.replaceAt( index, messageNew.substr( index, 1 ) );
				}
				return messageOld;
			}

			function decode( decoderId ) {
				if( decodeTimer ) {
					clearInterval( decodeTimer );
				}
				decodeProgress = 0;
				decodedMessage = deciphers[ decoderId ]( document.querySelector( "#decode-text" ).value );
				decodeTimer = setInterval( () => {
					decodeProgress += 1;
					document.querySelector( "#decode-progress" ).value = decodeProgress;
					document.querySelector( "#decode-text" ).value = scrambleCharacters( document.querySelector( "#decode-text" ).value, decodedMessage, Math.pow( decodeProgress / 100, 2 ) );
					if( decodeProgress >= 100 ) {
						clearInterval( decodeTimer );
						decodeTimer = null;
						document.querySelector( "#decode-text" ).value = decodedMessage;
						document.querySelector( "#decode-progress" ).value = 0;
					}
				}, 30 );
			}

			function generateSuspectClues( suspect, number = 10 ) {
				let sus = [];
				for( var i = 0; i < number; i++ ) {
					let clue = getRandomElement( suspectClueSentences );
					sus.push( replaceSuspectClue( suspect, clue ) );
				}
				return sus;
			}

			function replaceSuspectClue( suspect, sentence ) {
				return sentence
					.replace( /SPECIES/g, suspect.species )
					.replace( /GENDER/g, suspect.gender )
					.replace( /AGE/g, suspect.age )
					.replace( /NICKNAME/g, getRandomElement( suspect.nicknames ) )
					.replace( /CHARACTERISTIC/g, getRandomElement( suspect.characteristics ) )
					.replace( /SOUND/g, getRandomElement( suspect.sound ) )
			}

			function getRandomInt( max ) {
				return Math.floor( max * Math.random() );
			}

			function getRandomElement( arr ) {
				return arr[ getRandomInt( arr.length ) ];
			}

			var seed = 1;
			function pseudoRandom() {
			    var x = Math.sin(seed++) * 10000;
			    return x - Math.floor(x);
			}

			window.onload = function( ev ) {
				document.addEventListener('scroll', () => {
				var scrollPos = document.documentElement.scrollTop || document.body.scrollTop;
				});
				[].forEach.call(document.querySelectorAll('dialog'), (a) => {
					dialogPolyfill.registerDialog(a);
				});

				document.getElementById( 'dialog-dark' ).show();
			};
		</script>
	</body>
</html>
